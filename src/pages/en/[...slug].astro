---
import { type CollectionEntry, getCollection, render } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Container from "@components/Container.astro";
import FormattedDate from "@components/FormattedDate.astro";
import { readingTime, formatSlug } from "@lib/utils";
import BackToPrevious from "@components/BackToPrevious.astro";
import PostNavigation from "@components/PostNavigation.astro";

export async function getStaticPaths() {
	const posts = (await getCollection("blog"))
		.filter((post) => !post.data.draft)
		.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
	return posts.map((post) => ({
		params: { slug: formatSlug(post.id) },
		props: post,
	}));
}
type Props = CollectionEntry<"blog">;

const posts = (await getCollection("blog")).filter(
	(post) => !post.data.draft && post.data.language === "en",
);

function getNextPost() {
	let postIndex;
	for (const post of posts) {
		if (formatSlug(post.id) === Astro.params.slug) {
			postIndex = posts.indexOf(post);
			return posts[postIndex + 1];
		}
	}
}

function getPrevPost() {
	let postIndex;
	for (const post of posts) {
		if (formatSlug(post.id) === Astro.params.slug) {
			postIndex = posts.indexOf(post);
			return posts[postIndex - 1];
		}
	}
}

const nextPost = getNextPost();
const prevPost = getPrevPost();

const post = Astro.props;
const { Content, headings } = await render(post);
---

<Layout title={post.data.title} description={post.data.description}>
	<Container>
		<div class="animate">
			<BackToPrevious href="/en/blog">Back to blog</BackToPrevious>
		</div>
		<div class="my-10 space-y-1">
			<div class="animate flex items-center gap-1.5">
				<div class="font-base text-sm">
					<FormattedDate date={post.data.date} />
				</div>
				&bull;
				<div class="font-base text-sm">
					{readingTime(post.body)}
				</div>
			</div>
			<h1
				class="animate text-3xl font-semibold text-black dark:text-white"
			>
				{post.data.title}
			</h1>
		</div>

		<article class="animate">
			<Content />
			<div class="mt-24">
				<PostNavigation
					prevPost={prevPost}
					nextPost={nextPost}
					lang="/en"
				/>
			</div>
		</article>
	</Container>
</Layout>
